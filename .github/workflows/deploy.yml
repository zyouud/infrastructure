name: deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      run_mode:
        description: "What to run"
        required: true
        default: "build-and-deploy"
        type: choice
        options:
          - build-and-deploy
          - build-only
          - deploy-only

permissions:
  contents: read
  packages: write

env:
  NAMESPACE: zyoud
  FRONTEND_IMAGE: ghcr.io/zyouud/apptraining-frontend
  BACKEND_IMAGE: ghcr.io/zyouud/apptraining-backend

jobs:
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.run_mode == 'build-and-deploy' ||
      github.event.inputs.run_mode == 'build-only'

    outputs:
      tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag (immutable)
        id: tag
        shell: bash
        run: |
          TAG="${GITHUB_SHA::7}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG" >> "$GITHUB_ENV"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build & push backend
        run: |
          docker build -t "$BACKEND_IMAGE:${TAG}" ./backend
          docker push "$BACKEND_IMAGE:${TAG}"

      - name: Build & push frontend
        run: |
          docker build -t "$FRONTEND_IMAGE:${TAG}" ./frontend
          docker push "$FRONTEND_IMAGE:${TAG}"

  deploy:
    name: Deploy to K3s (Kustomize)
    runs-on: ubuntu-latest

    # If push: wait for build job
    # If manual deploy-only: run without build
    needs: [build]
    if: |
      github.event_name == 'push' ||
      github.event.inputs.run_mode == 'build-and-deploy' ||
      github.event.inputs.run_mode == 'deploy-only'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Figure out what TAG to deploy:
      # - If build ran in this workflow: use build output tag
      # - If deploy-only: use current commit short SHA
      - name: Set deploy tag
        shell: bash
        run: |
          if [ -n "${{ needs.build.outputs.tag }}" ]; then
            echo "TAG=${{ needs.build.outputs.tag }}" >> "$GITHUB_ENV"
          else
            echo "TAG=${GITHUB_SHA::7}" >> "$GITHUB_ENV"
          fi

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Debug K3S_SERVER (must not be 127.0.0.1)
        run: |
          echo "K3S_SERVER=${K3S_SERVER}"
          if echo "${K3S_SERVER}" | grep -q "127.0.0.1"; then
            echo "ERROR: K3S_SERVER is 127.0.0.1"
            exit 1
          fi
        env:
          K3S_SERVER: ${{ secrets.K3S_SERVER }}

      - name: Configure kubeconfig (k3s) - robust (NO SSH)
        shell: bash
        run: |
          set -euo pipefail

          : "${K3S_SERVER:?K3S_SERVER is empty}"
          : "${K3S_TOKEN:?K3S_TOKEN is empty}"
          : "${K3S_CA_CRT:?K3S_CA_CRT is empty}"

          mkdir -p ~/.kube

          echo "${K3S_CA_CRT}" | base64 -d > /tmp/ca.crt

          kubectl config set-cluster k3s \
            --server="${K3S_SERVER}" \
            --certificate-authority=/tmp/ca.crt \
            --embed-certs=true

          kubectl config set-credentials zyoud-gha \
            --token="${K3S_TOKEN}"

          kubectl config set-context zyoud \
            --cluster=k3s \
            --user=zyoud-gha \
            --namespace="${NAMESPACE}"

          kubectl config use-context zyoud

          kubectl version
          kubectl -n "${NAMESPACE}" get pods
          kubectl -n "${NAMESPACE}" get deploy
        env:
          K3S_SERVER: ${{ secrets.K3S_SERVER }}
          K3S_TOKEN: ${{ secrets.K3S_TOKEN }}
          K3S_CA_CRT: ${{ secrets.K3S_CA_CRT }}

      - name: Apply Kubernetes manifests (kustomize staging)
        run: |
          kubectl apply -k manifests/staging

      - name: Update images on Deployments (immutable tags)
        run: |
          kubectl -n ${NAMESPACE} set image deployment/zyoud-backend backend=${BACKEND_IMAGE}:${TAG}
          kubectl -n ${NAMESPACE} set image deployment/zyoud-frontend frontend=${FRONTEND_IMAGE}:${TAG}

      - name: Rollout status
        run: |
          kubectl -n ${NAMESPACE} rollout status deploy/zyoud-backend --timeout=180s
          kubectl -n ${NAMESPACE} rollout status deploy/zyoud-frontend --timeout=300s
