name: deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      run_mode:
        description: "What to run"
        required: true
        default: "build-and-deploy"
        type: choice
        options:
          - build-and-deploy
          - build-only
          - deploy-only

permissions:
  contents: read
  packages: write

env:
  NAMESPACE: zyoud
  FRONTEND_IMAGE: ghcr.io/zyouud/apptraining-frontend
  BACKEND_IMAGE: ghcr.io/zyouud/apptraining-backend

jobs:
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.run_mode == 'build-and-deploy' ||
      github.event.inputs.run_mode == 'build-only'

    outputs:
      tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag (immutable)
        id: tag
        shell: bash
        run: |
          TAG="${GITHUB_SHA::7}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG" >> "$GITHUB_ENV"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build & push backend
        shell: bash
        run: |
          docker build -t "$BACKEND_IMAGE:${TAG}" ./backend
          docker push "$BACKEND_IMAGE:${TAG}"

      - name: Build & push frontend
        shell: bash
        run: |
          docker build -t "$FRONTEND_IMAGE:${TAG}" ./frontend
          docker push "$FRONTEND_IMAGE:${TAG}"

  deploy:
    name: Deploy to K3s (Kustomize)
    runs-on: ubuntu-latest

    needs: [build]
    if: |
      github.event_name == 'push' ||
      github.event.inputs.run_mode == 'build-and-deploy' ||
      github.event.inputs.run_mode == 'deploy-only'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set deploy tag
        shell: bash
        run: |
          if [ -n "${{ needs.build.outputs.tag }}" ]; then
            echo "TAG=${{ needs.build.outputs.tag }}" >> "$GITHUB_ENV"
          else
            echo "TAG=${GITHUB_SHA::7}" >> "$GITHUB_ENV"
          fi

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.29.0"

      - name: Configure kubeconfig from Secret (plain text)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.kube

          # write kubeconfig (ensure newline at end)
          printf "%s\n" "${KUBECONFIG_YAML}" > ~/.kube/config

          # quick diagnostics (no secrets)
          kubectl config current-context || true
          kubectl cluster-info

          # namespace-scoped checks
          kubectl -n "${NAMESPACE}" get pods
          kubectl -n "${NAMESPACE}" get deploy
        env:
          KUBECONFIG_YAML: ${{ secrets.KUBECONFIG_YAML }}

      - name: Apply Kubernetes manifests (kustomize staging)
        shell: bash
        run: |
          kubectl apply -k manifests/staging

      - name: Update images on Deployments (immutable tags)
        shell: bash
        run: |
          kubectl -n "${NAMESPACE}" set image deployment/zyoud-backend backend="${BACKEND_IMAGE}:${TAG}"
          kubectl -n "${NAMESPACE}" set image deployment/zyoud-frontend frontend="${FRONTEND_IMAGE}:${TAG}"

      - name: Rollout status
        shell: bash
        run: |
          kubectl -n "${NAMESPACE}" rollout status deploy/zyoud-backend --timeout=180s
          kubectl -n "${NAMESPACE}" rollout status deploy/zyoud-frontend --timeout=300s
